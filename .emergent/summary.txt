<analysis>**original_problem_statement:**
The user wants to build Radio Check, a mental health and peer support application for veterans. The project includes a React Native mobile app, a Python FastAPI backend, and has expanded to feature user authentication, AI chat personas, a staff availability calendar, a Buddy Finder, a comprehensive CMS, and a standalone static marketing website. The primary goal is to provide a robust, self-contained support platform.

**PRODUCT REQUIREMENTS**
-   Functional peer-to-peer audio calls.
-   A working staff rota/calendar system.
-   A fully functional Content Management System (CMS) to allow admin users to update app content dynamically.
-   A marketing website to promote the app.
-   Admin and Staff web portals for managing the application and its users.
-   All portals and the app must be functional on both desktop and mobile devices.

**User's preferred language**: English

**what currently exists?**
The project comprises four distinct frontends and one backend:
1.  **React Native (Expo) Mobile App**: Features user authentication, AI chats, a non-functional calendar, and a Buddy Finder UI.
2.  **Static Marketing Website**: A standalone HTML/CSS/JS website located in .
3.  **Static Admin Portal**: An HTML/JS site in  for administration.
4.  **Static Staff Portal**: An HTML/JS site in  for peer supporters, including the WebRTC phone.
5.  **FastAPI Backend**: A monolithic Python server () with a MongoDB database, handling all API requests, user authentication, and WebRTC signaling.

WebRTC audio calls have been debugged and are now functional, pending the user configuring their microphone correctly. Session timeout logic has been added to the admin and staff portals.

**Last working item**:
-   **Last item agent was working**: The user reported two critical issues simultaneously:
    1.  The staff portal, when viewed on a mobile device, is not rendering the main functional components (alerts, live chat, phone). The console logs show numerous  errors.
    2.  The calendar/availability feature is broken. It does not appear at all in the web staff portal and is non-functional in the mobile app (users can pick a date/time, but the selection doesn't save).
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: Manual inspection of the staff portal on a mobile viewport and analysis of browser console logs.
-   **User Testing Done**: Y (User reported the current broken state).

**All Pending/In progress Issue list**:
-   **Issue 1**: Staff Portal is non-functional on mobile devices (P0)
-   **Issue 2**: The calendar/availability system is broken across the app and web portal (P0)
-   **Issue 3**: The CMS is not integrated with the app, leaving content hardcoded (P1)
-   **Issue 4**: The original request to generate a contact CSV has not been completed (P2)

**Issues Detail**:
-   **Issue 1: Staff Portal is non-functional on mobile devices**
    -   **Attempted fixes**: The agent reviewed the portal's HTML, CSS, and JS, finding no obvious code that would hide elements on mobile. The user provided console logs showing repeated  and  messages. This strongly suggests the API calls to load data for the portal sections are failing due to an expired session token, which is a side effect of the recently implemented session timeout feature.
    -   **Next debug checklist**:
        1.  Instruct the user to log out and log back into the staff portal on their mobile device to obtain a fresh authentication token.
        2.  Verify that after re-authenticating, the API calls succeed and the functional sections (alerts, chat, phone) become visible.
        3.  If sections still don't appear, investigate  to debug the role-based logic that shows/hides these elements.
    -   **Why fix this issue and what will be achieved with the fix?**: Staff members must be able to access all portal features on mobile devices to manage their responsibilities effectively.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: None

-   **Issue 2: The calendar/availability system is broken**
    -   **Attempted fixes**: None. This is a newly reported issue.
    -   **Next debug checklist**:
        1.  **For Web Staff Portal**: Investigate  to determine why the calendar component is not being rendered. Check for JavaScript errors or incorrect conditional logic.
        2.  **For Mobile App**: Examine . Trace the function that handles saving the selected date and time. It is likely missing the API call to the backend endpoint () to persist the data.
        3.  Implement the missing API call in the mobile app and fix the rendering logic in the staff portal.
    -   **Why fix this issue and what will be achieved with the fix?**: This is a core feature enabling the peer support rota. Without it, staff cannot set their availability.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: None

**In progress Task List**:
-   **Task 1: Fix Staff Portal Mobile Functionality (P0)**
    -   **Where to resume**: Guiding the user to re-authenticate to resolve the  errors, which is the likely cause of the missing UI elements.
    -   **What will be achieved with this?**: A fully functional staff portal on mobile devices.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on something**: User action (re-login).

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **(P0) Fix Calendar Functionality**: Implement the logic for saving and displaying staff availability in both the app and staff portal.
    -   **(P1) Make CMS Fully Dynamic**: Refactor app pages (, , etc.) to fetch content from the CMS APIs instead of using hardcoded data.
    -   **(P2) Complete Buddy Finder Frontend**: Connect the Buddy Finder UI in  to the backend APIs.
-   **Future Tasks**:
    -   **(P2) Implement Email Notifications for Rota**: Integrate an email service to notify staff of their shifts.
    -   **(Refactor)** Modularize the monolithic  into a more structured architecture (e.g., routers, models, services).
    -   **(Refactor)** Create a single, reusable AI chat component to reduce code duplication in the mobile app.

**Completed work in this session**
-   **WebRTC Audio Calls Fixed**: Successfully debugged and resolved the one-way/no-audio issue. The root cause was identified as an incorrect microphone selection on the user's desktop. Implemented robust ICE candidate queueing to prevent connection race conditions and fixed a UI bug on the staff portal's call banner.
-   **Marketing Website Rebuilt & Enhanced**: Replaced the previous React-based website with a new static HTML/CSS/JS version to ensure compatibility with the user's hosting. The new site includes a hero banner, correct AI avatars with consistent sizing, expandable/modal-based info cards, a favicon, and an improved layout.
-   **AI Avatars Generated & Updated**: Created new, unique avatars for the AI personas 'Margie' and 'Hugo' and updated them across both the mobile app and the marketing website.
-   **Session Timeout Implemented**: Added automatic session expiration to the Admin and Staff portals (2-hour inactivity, 24-hour absolute) to enhance security, requiring users to log in again after prolonged absence.
-   **Mobile App Splash Screen Improved**: Fixed the text color on the app's splash screen to ensure it is clearly readable against the background.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Generate contact information CSV**
    -   **Debug checklist**: Execute the script  and provide the resulting  file to the user.
    -   **Why to solve this issue and what will be achieved with this?**: This is a pending, direct request from the user for auditing purposes.
    -   **Should Test frontend/backend/both after fix?**: NA
    -   **Is recurring issue?**: Y

**Code Architecture**


**Key Technical Concepts**
-   **Frontend (App)**: React Native, Expo, TypeScript
-   **Frontend (Website/Portals)**: Static HTML, CSS, JavaScript
-   **Backend**: Python, FastAPI, Pydantic, python-socketio
-   **Database**: MongoDB
-   **Real-time Communication**: WebSockets (Socket.IO) for signaling and WebRTC for peer-to-peer audio calls.
-   **Authentication**: JSON Web Tokens (JWT) stored in localStorage.

**key DB schema**
-   **users**: {email, hashed_password, role}
-   **RotaShift**: {date, start_time, end_time, user_id}
-   **CMS Models**: , ,  for content.

**All files of reference**
-   : Core logic for the staff portal, where mobile view and calendar are broken.
-   : Mobile app screen for the non-functional calendar.
-   : Contains all WebRTC logic for the mobile app.
-   : Contains all WebRTC logic for the staff portal.
-   : Directory containing the newly rebuilt static marketing website.
-   : The deployment artifact for the marketing website.

**Critical Info for New Agent**
-   **The  errors are key**: The user's primary complaint about the staff portal on mobile (missing features) is almost certainly caused by the  errors they provided in the console logs. This is a result of the new session timeout logic. The first step must be to have the user log out and back in to get a valid token.
-   **Microphone Issue was User-Side**: The multi-day audio call issue was resolved by the user switching to a working microphone on their desktop. The WebRTC code itself is now in a much more robust state.
-   **Four Distinct Frontends**: Be mindful that you are maintaining four separate frontends (React Native App, Website, Admin Portal, Staff Portal). A feature or fix might require changes in multiple locations.
-   **Production vs. Preview Environment**: The user often reports issues on their live, deployed site. Always remind them that changes made here are only in the preview environment and require a Git push and redeployment to go live.

**documents and test reports created in this job**
-    (updated multiple times with new features and fixes)

**Last 10 User Messages and any pending HUMAN messages**
1.  **Request (In Progress)**: Fix the calendar (not showing in portal, not working in app) and the staff portal mobile view (missing all key features like alerts, calls, chats).
2.  **Report**: Two-way audio is now working after switching microphones. Provided console logs showing many  errors on the staff portal.
3.  **Request**: Asked for instructions on how to use their new  TURN server account.
4.  **Request**: Stated the staff portal on mobile must have the same functions as the desktop version.
5.  **Report**: Confirmed their desktop mic was not working with an online test tool.
6.  **Report**: WebRTC audio issue persists on Edge mobile browser.
7.  **Report**: Mobile debug overlay shows , , , but one-way audio persists.
8.  **Question**: Asked how to view the browser console on a mobile phone.
9.  **Request**: Generate new, unique avatars for AI personas Margie and Hugo.
10. **Request**: Staff and Admin portals are not logging users out after a few hours of inactivity.

**Project Health Check:**
-   **Broken**:
    -   Staff Portal is not functional on mobile devices due to authentication failures.
    -   The core Calendar/Rota availability feature is non-operational.
-   **Mocked**:
    -   The CMS backend exists, but no app pages are connected to it, rendering it useless.
    -   The Buddy Finder UI is not connected to any backend logic.

**3rd Party Integrations**
-   **OpenAI**: Used for the backend AI chat functionality.
-   **Metered.ca (Pending)**: The user has created an account to get reliable TURN server credentials for WebRTC. These credentials have not yet been provided or implemented in the code.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: []
-   **Known regressions**: The Calendar feature and Staff Portal mobile usability have been identified as broken.

**What agent forgot to execute**
-   The task to generate a CSV of contact information using  has been carried over from a previous session and is still pending.</analysis>
